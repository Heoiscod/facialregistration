<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="styles/admin.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="nav-item active" onclick="showSection('dashboard', this)">Dashboard</div>
    <div class="nav-item" onclick="showSection('account-status', this)">Account Status</div>
    <div class="nav-item" onclick="showSection('logs', this)">Logs</div>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Registration Form -->
    <div id="dashboard" class="section active">
      <h2>Registration Form</h2>
      <form id="registrationForm">
        <label>School ID:</label>
        <input type="text" id="school_id" required>
        <label>Username:</label>
        <input type="text" id="username" required>
        <label>Name:</label>
        <input type="text" id="name" required>
        <label>Lastname:</label>
        <input type="text" id="lastname" required>
        <label>Age:</label>
        <input type="number" id="age" required>
        <label>Email:</label>
        <input type="email" id="email" required>
        <label>Birthdate:</label>
        <input type="date" id="birthdate" required>
        <label>Password (auto-generated):</label>
        <input type="text" id="password" readonly>
        <button type="submit">Submit</button>
      </form>
      <div id="message"></div>
    </div>

    <!-- Account Status -->
    <div id="account-status" class="section">
      <h2>Account Status</h2>
      <table id="accountsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>School ID</th>
            <th>Username</th>
            <th>Name</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Logs -->
    <div id="logs" class="section">
      <h2>Logs</h2>
      <table id="logsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Action</th>
            <th>User</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://ozthqxbitctlrmiukkor.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96dGhxeGJpdGN0bHJtaXVra29yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTU4ODAsImV4cCI6MjA3MjI3MTg4MH0.jOrD1HNW_48C_ZldY7XjYTX7wtJle6rSZ4w9azbBEnM"; // ⚠️ use anon/public key only
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    function showSection(id, element) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      element.classList.add('active');
    }

    const form = document.getElementById("registrationForm");
    const passwordField = document.getElementById("password");
    const message = document.getElementById("message");

    // Auto-generate password
    form.addEventListener("input", () => {
      const name = document.getElementById("name").value.trim();
      const lastname = document.getElementById("lastname").value.trim();
      if (name && lastname) passwordField.value = `${name}.${lastname}123`;
    });

    // Submit handler
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      message.style.color = "blue";
      message.textContent = "⏳ Sending data to Supabase...";

      const data = {
        school_id: document.getElementById("school_id").value,
        username: document.getElementById("username").value,
        name: document.getElementById("name").value,
        lastname: document.getElementById("lastname").value,
        age: document.getElementById("age").value,
        email: document.getElementById("email").value,
        birthdate: document.getElementById("birthdate").value,
        password: document.getElementById("password").value
      };

      const { data: inserted, error } = await supabase.from("users").insert([data]).select();
      if (error) {
        message.style.color = "red";
        message.textContent = "❌ " + error.message;
      } else {
        message.style.color = "green";
        message.textContent = "✅ Registration successful! Redirecting to Step 2...";
        
        const newUserId = inserted[0].id;

        // Save current userId for Step 2
        localStorage.setItem("currentUserId", newUserId);

        // Redirect to face registration page
        setTimeout(() => {
          window.location.href = "faceregistration.html";
        }, 1500);
      }
    });

    async function loadAccounts() {
      const { data, error } = await supabase.from("users").select("*");
      if (!error) {
        const tbody = document.querySelector("#accountsTable tbody");
        tbody.innerHTML = "";
        data.forEach(user => {
          tbody.innerHTML += `
            <tr>
              <td>${user.id}</td>
              <td>${user.school_id}</td>
              <td>${user.username}</td>
              <td>${user.name} ${user.lastname}</td>
              <td>${user.email}</td>
            </tr>
          `;
        });
      }
    }

    async function loadLogs() {
      const { data, error } = await supabase.from("logs").select("*").order("id", { ascending: false });
      if (!error) {
        const tbody = document.querySelector("#logsTable tbody");
        tbody.innerHTML = "";
        data.forEach(log => {
          tbody.innerHTML += `
            <tr>
              <td>${log.id}</td>
              <td>${log.action}</td>
              <td>${log.user}</td>
              <td>${log.created_at}</td>
            </tr>
          `;
        });
      }
    }

    loadAccounts();
    loadLogs();
  </script>
</body>
</html>
